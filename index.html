<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Countdown Timer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: sans-serif;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            background-color: white;
        }

        #timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            font-size: 80vmin;
            color: #333;
            transition: color 0.2s ease, transform 0.3s ease;
            user-select: none;
        }

        #optionsBtn {
            position: absolute;
            left: 50%;
            top: 2em;
            transform: translateX(-50%);
            font-size: 2em;
            padding: 0.5em 1em;
            background: #2980b9;
            color: #fff;
            border: none;
            border-radius: 0.5em;
            cursor: pointer;
            display: none;
            z-index: 10;
        }

        #optionsPanel {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 0.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2em;
            min-width: 150px;
            display: none;
            z-index: 10;
            transition: max-height 0.3s ease;
        }

            #optionsPanel.show {
                display: block;
            }

        .player-checkbox {
            margin-bottom: 0.5em;
            display: flex;
            align-items: center;
        }

            .player-checkbox label {
                margin-left: 0.5em;
            }

        #intervalInput {
            width: 60px;
            font-size: 1em;
            margin-left: 0.5em;
        }

        .options-actions {
            display: flex;
            justify-content: space-between;
            gap: 1em;
            margin-top: 2em;
        }

        .icon-btn {
            font-size: 1.8em;
            padding: 0.2em 0.6em;
            border: none;
            border-radius: 0.4em;
            cursor: pointer;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #okBtn {
            color: #27ae60;
        }

            #okBtn:hover {
                background: #eafaf1;
            }

        #cancelBtn {
            color: #e74c3c;
        }

            #cancelBtn:hover {
                background: #fdeaea;
            }
    </style>
</head>
<body>
    <div id="timer">40</div>
    <button id="optionsBtn">Opcje</button>
    <div id="optionsPanel">
        <div class="player-checkbox">
            <input type="checkbox" id="player1">
            <label for="player1" style="color: #333;">Gracz A (↓)</label>
        </div>
        <div class="player-checkbox">
            <input type="checkbox" id="player2">
            <label for="player2" style="color: #e74c3c;">Gracz B (←)</label>
        </div>
        <div class="player-checkbox">
            <input type="checkbox" id="player3">
            <label for="player3" style="color: #2980b9;">Gracz C (↑)</label>
        </div>
        <div class="player-checkbox">
            <input type="checkbox" id="player4">
            <label for="player4" style="color: #27ae60;">Gracz D (→)</label>
        </div>
        <div style="margin-top:1em;">
            <label for="intervalInput">Czas:</label>
            <input type="number" id="intervalInput" min="5" max="300" value="40" />
        </div>
        <div class="options-actions">
            <button id="okBtn" class="icon-btn" title="OK">&#10003;</button>
            <button id="cancelBtn" class="icon-btn" title="Cancel">&#10005;</button>
        </div>
    </div>
    <!-- Preload sounds -->
    <audio id="tickSound" src="sounds/tick.mp3" preload="auto"></audio>
    <audio id="gongSound" src="sounds/gong.mp3" preload="auto"></audio>
    <script>
        // Constants and State
        const START_TIME = 40;
        let countdown = START_TIME;
        let intervalId;
        let rotation = 270;
        let isPaused = false;
        let longPressTimeout;
        let lastPressTime = 0;

        const optionsState = {
            interval: START_TIME,
            players: [true, true, true, true]
        };

        const colors = ['#333', '#e74c3c', '#2980b9', '#27ae60'];
        let colorIndex = 3;
        let currentPlayer = 3;

        // DOM Elements
        const timerElement = document.getElementById('timer');
        const tickSound = document.getElementById('tickSound');
        const gongSound = document.getElementById('gongSound');
        const optionsBtn = document.getElementById('optionsBtn');
        const optionsPanel = document.getElementById('optionsPanel');
        const intervalInput = document.getElementById('intervalInput');
        const okBtn = document.getElementById('okBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const playerCheckboxes = [
            document.getElementById('player1'),
            document.getElementById('player2'),
            document.getElementById('player3'),
            document.getElementById('player4')
        ];

        // Initialize Player Checkboxes
        playerCheckboxes.forEach((checkbox, index) => {
            checkbox.checked = optionsState.players[index];
        });

        // Helper Functions
        function playSound(sound) {
            sound.currentTime = 0;
            sound.play();
        }

        function updateTimerAppearance() {
            timerElement.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`;
            timerElement.style.color = colors[colorIndex];
        }

        function hideOptionsPanel() {
            optionsPanel.classList.remove("show");
            window._optionsPanelOpen = false;
        }

        // Core Functions
        function startCountdown() {
            if (!optionsState.players.some(isActive => isActive)) {
                alert("Brak graczy, włącz przynajmniej jednego");
                return;
            }

            clearInterval(intervalId);
            countdown = START_TIME;
            timerElement.textContent = countdown;

            do {
                currentPlayer = (currentPlayer + 1) % 4;
                rotation += 90;
                colorIndex = (colorIndex + 1) % colors.length;
            } while (!optionsState.players[currentPlayer]);

            updateTimerAppearance();
            isPaused = false;
            timerElement.style.opacity = 1;
            optionsBtn.style.display = "none";
            hideOptionsPanel();

            intervalId = setInterval(tick, 1000);
        }

        function tick() {
            if (!isPaused) {
                countdown--;
                timerElement.textContent = countdown;
                if (countdown <= 5 && countdown > 0) playSound(tickSound);
                if (countdown <= 0) {
                    clearInterval(intervalId);
                    timerElement.textContent = 0;
                    playSound(gongSound);
                }
            }
        }

        function handleLongPress() {
            isPaused = !isPaused;
            timerElement.style.opacity = isPaused ? 0.5 : 1;
            optionsBtn.style.display = isPaused ? "block" : "none";
            if (!isPaused) hideOptionsPanel();
        }

        // Event Listeners
        document.body.addEventListener('pointerdown', (e) => {
            if (e.target === optionsBtn || optionsPanel.contains(e.target)) return;
            lastPressTime = Date.now();
            longPressTimeout = setTimeout(handleLongPress, 500);
        });

        document.body.addEventListener('pointerup', (e) => {
            if (e.target === optionsBtn || optionsPanel.contains(e.target)) return;
            if (longPressTimeout) {
                clearTimeout(longPressTimeout);
                longPressTimeout = null;
                if (window._optionsPanelOpen) return;
                if (Date.now() - lastPressTime < 500) {
                    isPaused ? handleLongPress() : startCountdown();
                }
            }
        });

        optionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            optionsPanel.classList.toggle("show");
            window._optionsPanelOpen = !window._optionsPanelOpen;
        });

        intervalInput.addEventListener('change', () => {
            const val = parseInt(intervalInput.value, 10);
            if (!isNaN(val) && val >= 5 && val <= 300) {
                optionsState.interval = val;
                countdown = val;
                timerElement.textContent = countdown;
            }
        });

        okBtn.addEventListener('click', () => {
            const val = parseInt(intervalInput.value, 10);
            if (!isNaN(val) && val >= 5 && val <= 300) {
                optionsState.interval = val;
                countdown = val;
                timerElement.textContent = countdown;
            }
            optionsState.players = playerCheckboxes.map(cb => cb.checked);
            hideOptionsPanel();
        });

        cancelBtn.addEventListener('click', () => {
            intervalInput.value = optionsState.interval;
            playerCheckboxes.forEach((cb, i) => cb.checked = optionsState.players[i]);
            hideOptionsPanel();
        });

        // Start the Timer
        startCountdown();
    </script>
</body>
</html>